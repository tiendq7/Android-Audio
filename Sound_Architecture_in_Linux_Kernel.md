# üéµ ALSA trong Kernel Space
Trong h·ªá th·ªëng Audio c·ªßa Android, t·∫ßng kernel ƒë√≥ng vai tr√≤ quan tr·ªçng trong vi·ªác k·∫øt n·ªëi ph·∫ßn m·ªÅm v·ªõi ph·∫ßn c·ª©ng √¢m thanh. Nh∆∞ ƒë√£ ƒë∆∞·ª£c tr√¨nh b√†y trong s∆° ƒë·ªì [Overview](./Overview_Android_Audio.md) **T·ªïng quan h·ªá th·ªëng Audio trong Android** ‚Äî t·ª´ Application nh∆∞ Media Player hay Media Recorder ‚Äî s·∫Ω l·∫ßn l∆∞·ª£t ƒëi qua c√°c l·ªõp framework, JNI, native library, c√°c service nh∆∞ AudioFlinger v√† AudioPolicy trong Media Server, sau ƒë√≥ truy·ªÅn xu·ªëng l·ªõp HAL (Hardware Abstraction Layer) v√† cu·ªëi c√πng l√† **Linux Kernel**. Ch√≠nh t·∫°i t·∫ßng kernel n√†y, audio driver s·∫Ω ƒë·∫£m nh·∫≠n nhi·ªám v·ª• giao ti·∫øp tr·ª±c ti·∫øp v·ªõi ph·∫ßn c·ª©ng nh∆∞ b·ªô m√£ h√≥a/gi·∫£i m√£ √¢m thanh (codec), giao ti·∫øp I2S/PCM, ADC/DAC‚Ä¶

Tr√™n Linux, c√≥ hai ki·∫øn tr√∫c audio ph·ªï bi·∫øn t·ª´ng ƒë∆∞·ª£c s·ª≠ d·ª•ng l√† **OSS (Open Sound System)** v√† **ALSA (Advanced Linux Sound Architecture)**. OSS l√† h·ªá th·ªëng √¢m thanh ban ƒë·∫ßu trong Linux, nh∆∞ng n√≥ b·ªôc l·ªô nhi·ªÅu h·∫°n ch·∫ø nh∆∞ thi·∫øu kh·∫£ nƒÉng m·ªü r·ªông, thi·∫øu h·ªó tr·ª£ mixer control v√† kh√≥ t√≠ch h·ª£p v·ªõi c√°c y√™u c·∫ßu ph·ª©c t·∫°p c·ªßa ph·∫ßn c·ª©ng hi·ªán ƒë·∫°i. Trong khi ƒë√≥, ALSA ƒë∆∞·ª£c thi·∫øt k·∫ø ƒë·ªÉ thay th·∫ø OSS v·ªõi kh·∫£ nƒÉng h·ªó tr·ª£ t·ªët h∆°n cho card √¢m thanh hi·ªán ƒë·∫°i, cho ph√©p qu·∫£n l√Ω nhi·ªÅu thi·∫øt b·ªã c√πng l√∫c, c√≥ giao di·ªán l·∫≠p tr√¨nh phong ph√∫, h·ªó tr·ª£ mixer, control,... v√† kh·∫£ nƒÉng t√≠ch h·ª£p cao v·ªõi c√°c h·ªá th·ªëng nh∆∞ Android.

V√¨ nh·ªØng l√Ω do ƒë√≥, ng√†y nay ALSA tr·ªü th√†nh ki·∫øn tr√∫c ch√≠nh ƒë∆∞·ª£c s·ª≠ d·ª•ng trong ph·∫ßn l·ªõn thi·∫øt b·ªã Android. Audio HAL c·ªßa Android th∆∞·ªùng √°nh x·∫° xu·ªëng ALSA driver trong kernel, v√† t·ª´ ƒë√≥ t∆∞∆°ng t√°c tr·ª±c ti·∫øp v·ªõi ph·∫ßn c·ª©ng codec, I2S hay c√°c m·∫°ch x·ª≠ l√Ω t√≠n hi·ªáu √¢m thanh.

Trong ch∆∞∆°ng n√†y, ch√∫ng ta s·∫Ω t·∫≠p trung ho√†n to√†n v√†o ALSA ·ªü t·∫ßng kernel space, ƒë·∫∑c bi·ªát l√† ki·∫øn tr√∫c ASoC (ALSA System on Chip), v·ªën ƒë∆∞·ª£c thi·∫øt k·∫ø ri√™ng ƒë·ªÉ h·ªó tr·ª£ c√°c n·ªÅn t·∫£ng nh√∫ng nh∆∞ smartphone, tablet ho·∫∑c board nh√∫ng nh∆∞ BeagleBone, STM32 hay Raspberry Pi.

## üîç ALSA l√† g√¨? (Advanced Linux Sound Architecture)

**ALSA (Advanced Linux Sound Architecture)** l√† m·ªôt framework √¢m thanh v√† l√† m·ªôt ph·∫ßn c·ªßa **nh√¢n Linux**, cung c·∫•p ch·ª©c nƒÉng **x·ª≠ l√Ω √¢m thanh (audio)** v√† **MIDI** cho c√°c h·ªá th·ªëng d·ª±a tr√™n Linux.

C·ª• th·ªÉ, ALSA ƒë·∫£m nhi·ªám c√°c vai tr√≤ sau:

- Giao ti·∫øp tr·ª±c ti·∫øp v·ªõi **driver thi·∫øt b·ªã √¢m thanh**
- Qu·∫£n l√Ω qu√° tr√¨nh **x·ª≠ l√Ω t√≠n hi·ªáu √¢m thanh**
- L√† c·∫ßu n·ªëi gi·ªØa **h·ªá ƒëi·ªÅu h√†nh** v√† **ph·∫ßn c·ª©ng √¢m thanh**

V·ªõi ALSA, h·ªá ƒëi·ªÅu h√†nh Linux c√≥ th·ªÉ:

- Thu v√† ph√°t √¢m thanh th√¥ng qua card √¢m thanh
- ƒêi·ªÅu khi·ªÉn mixer v√† √¢m l∆∞·ª£ng
- G·ª≠i v√† nh·∫≠n t√≠n hi·ªáu MIDI
- H·ªó tr·ª£ ƒë·ªìng th·ªùi nhi·ªÅu thi·∫øt b·ªã √¢m thanh

üîß V√¨ ƒë∆∞·ª£c t√≠ch h·ª£p tr·ª±c ti·∫øp trong nh√¢n, ALSA cho ph√©p truy c·∫≠p √¢m thanh v·ªõi **hi·ªáu nƒÉng cao**, h·ªó tr·ª£ **x·ª≠ l√Ω th·ªùi gian th·ª±c** v√† kh·∫£ nƒÉng m·ªü r·ªông ƒë·∫øn **nhi·ªÅu thi·∫øt b·ªã** c√πng l√∫c.

---
## ‚öôÔ∏è C·∫•u tr√∫c driver ALSA trong nh√¢n Linux

![alt text](alsa_overview.png)

Driver ALSA trong Linux ƒë∆∞·ª£c t·ªï ch·ª©c th√†nh nh∆∞ h√¨nh tr√™n, t·ª´ kh√¥ng gian ng∆∞·ªùi d√πng (user space) cho ƒë·∫øn ph·∫ßn c·ª©ng (hardware). M·ªói t·∫ßng ƒë√≥ng m·ªôt vai tr√≤ quan tr·ªçng trong vi·ªác truy·ªÅn v√† x·ª≠ l√Ω d·ªØ li·ªáu √¢m thanh, ƒë·ªìng th·ªùi b·∫£o ƒë·∫£m t√≠nh linh ho·∫°t v√† kh·∫£ nƒÉng m·ªü r·ªông cho c√°c h·ªá th·ªëng kh√°c nhau, ƒë·∫∑c bi·ªát trong m√¥i tr∆∞·ªùng nh√∫ng nh∆∞ Android, Raspberry Pi ho·∫∑c c√°c SoC.


### 1. User Space

L·ªõp tr√™n c√πng c·ªßa h·ªá th·ªëng ALSA l√† kh√¥ng gian ng∆∞·ªùi d√πng, n∆°i c√°c ·ª©ng d·ª•ng t∆∞∆°ng t√°c v·ªõi h·ªá th·ªëng √¢m thanh th√¥ng qua th∆∞ vi·ªán ALSA:

- **Client Application**: Bao g·ªìm c√°c ·ª©ng d·ª•ng nh∆∞ `aplay`, `arecord`, `VLC`, ho·∫∑c c√°c ·ª©ng d·ª•ng C/C++ t√πy bi·∫øn. C√°c ·ª©ng d·ª•ng n√†y s·ª≠ d·ª•ng API ALSA ƒë·ªÉ ph√°t ho·∫∑c thu √¢m thanh.
- **alsa-utils**: T·∫≠p h·ª£p c√°c c√¥ng c·ª• d√≤ng l·ªánh gi√∫p ki·ªÉm tra v√† ƒëi·ªÅu khi·ªÉn thi·∫øt b·ªã √¢m thanh.
- **alsa-lib (libasound)**: Th∆∞ vi·ªán ng∆∞·ªùi d√πng trung gian gi·ªØa ·ª©ng d·ª•ng v√† kernel, cung c·∫•p c√°c API nh∆∞ `snd_pcm_*`, `snd_ctl_*`, `snd_mixer_*` ƒë·ªÉ thao t√°c v·ªõi thi·∫øt b·ªã √¢m thanh th√¥ng qua node `/dev/snd/*`.

### 2. ALSA Kernel Framework

ƒê√¢y l√† ph·∫ßn c·ªët l√µi c·ªßa ALSA n·∫±m trong nh√¢n Linux, ch·ªãu tr√°ch nhi·ªám x·ª≠ l√Ω ch√≠nh c√°c ho·∫°t ƒë·ªông li√™n quan ƒë·∫øn stream √¢m thanh:

- **PCM (Pulse Code Modulation)**: Qu·∫£n l√Ω lu·ªìng d·ªØ li·ªáu √¢m thanh k·ªπ thu·∫≠t s·ªë. Th√¥ng qua c√°c buffer v√† c∆° ch·∫ø DMA, PCM cho ph√©p ph√°t (`playback`) v√† thu (`capture`) √¢m thanh.
- **Control Interface**: Cho ph√©p truy c·∫≠p c√°c th√†nh ph·∫ßn ƒëi·ªÅu khi·ªÉn nh∆∞ volume, mute, gain ho·∫∑c mixer. Th√¥ng tin ƒëi·ªÅu khi·ªÉn ƒë∆∞·ª£c √°nh x·∫° qua giao di·ªán `/dev/snd/controlC*`.

### 3. ASoC ‚Äì ALSA System on Chip

ƒê·ªÉ h·ªó tr·ª£ c√°c h·ªá th·ªëng nh√∫ng, ALSA ƒë∆∞·ª£c m·ªü r·ªông v·ªõi l·ªõp ASoC. L·ªõp n√†y gi√∫p t√°ch bi·ªát ph·∫ßn m·ªÅm v√† ph·∫ßn c·ª©ng b·∫±ng c√°ch ƒë·ªãnh nghƒ©a c√°c giao di·ªán chung gi·ªØa CPU v√† codec √¢m thanh:

- **soc-core**: Th√†nh ph·∫ßn trung t√¢m c·ªßa ASoC, ch·ªãu tr√°ch nhi·ªám li√™n k·∫øt c√°c driver CPU, codec v√† machine driver. ƒê·ªìng th·ªùi, qu·∫£n l√Ω c·∫•u tr√∫c thi·∫øt b·ªã √¢m thanh th√¥ng qua khung `snd_soc_card`.
- **pcm-dmaengine**: Driver cho c∆° ch·∫ø truy·ªÅn d·ªØ li·ªáu √¢m thanh t·ª´ b·ªô nh·ªõ ƒë·∫øn ph·∫ßn c·ª©ng th√¥ng qua DMA, gi·∫£m t·∫£i cho CPU.
- **DAPM (Dynamic Audio Power Management)**: H·ªá th·ªëng qu·∫£n l√Ω nƒÉng l∆∞·ª£ng ƒë·ªông gi√∫p t·ª± ƒë·ªông b·∫≠t/t·∫Øt c√°c ph·∫ßn t·ª≠ √¢m thanh kh√¥ng c·∫ßn thi·∫øt nh·∫±m ti·∫øt ki·ªám ƒëi·ªán nƒÉng.

### 4. ASoC Drivers

L·ªõp n√†y ch·ª©a c√°c driver t∆∞∆°ng ·ª©ng v·ªõi ph·∫ßn c·ª©ng c·ª• th·ªÉ c·ªßa n·ªÅn t·∫£ng:

- **Machine Driver**: ƒê·ªãnh nghƒ©a c·∫•u tr√∫c k·∫øt n·ªëi c·ª• th·ªÉ cho t·ª´ng board (v√≠ d·ª•: Raspberry Pi, BeagleBone). Thi·∫øt l·∫≠p ƒë∆∞·ªùng ƒëi t√≠n hi·ªáu gi·ªØa CPU ‚Üî Codec ‚Üî Loa/Mic.
- **CPU DAI Driver (Digital Audio Interface)**: ƒêi·ªÅu khi·ªÉn giao ti·∫øp s·ªë nh∆∞ I2S, PCM, TDM. ƒê∆∞·ª£c √°nh x·∫° t·ªõi c√°c ph·∫ßn t·ª≠ ph·∫ßn c·ª©ng nh∆∞ b·ªô ƒëi·ªÅu khi·ªÉn √¢m thanh trong SoC.
- **Codec Driver**: Giao ti·∫øp v·ªõi chip codec v·∫≠t l√Ω th√¥ng qua I2C ho·∫∑c SPI, c·∫•u h√¨nh c√°c th√¥ng s·ªë nh∆∞ volume, gain, sampling rate,‚Ä¶

### 5. Hardware

T·∫ßng d∆∞·ªõi c√πng l√† c√°c th√†nh ph·∫ßn v·∫≠t l√Ω bao g·ªìm:

- **CPU DAI Peripheral**: Kh·ªëi ph·∫ßn c·ª©ng trong SoC ch·ªãu tr√°ch nhi·ªám g·ª≠i/nh·∫≠n d·ªØ li·ªáu √¢m thanh s·ªë (I2S, PCM...).
- **Codec ho·∫∑c Audio Connector**: IC chuy·ªÉn ƒë·ªïi t√≠n hi·ªáu s·ªë ‚Üî analog (DAC/ADC), ho·∫∑c c√°c ƒë·∫ßu k·∫øt n·ªëi v·ªõi loa, micro ho·∫∑c tai nghe.
  
---

## üéß Features of ALSA (Advanced Linux Sound Architecture) in Linux

ALSA l√† n·ªÅn t·∫£ng √¢m thanh ch√≠nh th·ª©c trong Linux kernel, cung c·∫•p giao di·ªán c·∫•p th·∫•p ƒë·ªÉ giao ti·∫øp v·ªõi ph·∫ßn c·ª©ng √¢m thanh. D∆∞·ªõi ƒë√¢y l√† c√°c t√≠nh nƒÉng n·ªïi b·∫≠t c·ªßa ALSA:

### üîå Low-Level Hardware Access

ALSA t∆∞∆°ng t√°c tr·ª±c ti·∫øp v·ªõi ph·∫ßn c·ª©ng √¢m thanh th√¥ng qua c√°c kernel driver m√† kh√¥ng c·∫ßn th√¥ng qua c√°c t·∫ßng tr·ª´u t∆∞·ª£ng trung gian.

- Gi√∫p gi·∫£m ƒë·ªô tr·ªÖ √¢m thanh (low-latency).
- Cho ph√©p truy c·∫≠p v√† c·∫•u h√¨nh chi ti·∫øt c√°c tham s·ªë ph·∫ßn c·ª©ng nh∆∞ `bit depth`, `sample rate`, `channel layout`.
- H·ªØu √≠ch cho vi·ªác ph√°t tri·ªÉn driver t√πy ch·ªânh cho thi·∫øt b·ªã √¢m thanh m·ªõi.
  
Ki·ªÉm tra danh s√°ch c√°c sound card ƒë∆∞·ª£c h·ªá th·ªëng nh·∫≠n di·ªán:
```
cat /proc/asound/cards
```
### üéõÔ∏è Multiple Sound Card Support

ALSA c√≥ kh·∫£ nƒÉng qu·∫£n l√Ω ƒë·ªìng th·ªùi nhi·ªÅu sound card trong m·ªôt h·ªá th·ªëng.

- Ng∆∞·ªùi d√πng c√≥ th·ªÉ ch·ªçn card n√†o ƒë·ªÉ playback ho·∫∑c record.
- H·ªó tr·ª£ t·ªët cho h·ªá th·ªëng c√≥ c·∫£ sound card t√≠ch h·ª£p v√† USB.
- Cung c·∫•p kh·∫£ nƒÉng ƒë·ªãnh tuy·∫øn √¢m thanh gi·ªØa c√°c thi·∫øt b·ªã kh√°c nhau.

Li·ªát k√™ t·∫•t c·∫£ c√°c thi·∫øt b·ªã √¢m thanh:
```
aplay -l
```
### üéôÔ∏è PCM (Pulse Code Modulation) Support

ALSA h·ªó tr·ª£ PCM ‚Äî chu·∫©n ƒë·ªãnh d·∫°ng √¢m thanh s·ªë ph·ªï bi·∫øn nh·∫•t hi·ªán nay.

- Cho ph√©p playback v√† recording ·ªü nhi·ªÅu c·∫•u h√¨nh: mono, stereo, multichannel.
- H·ªó tr·ª£ t√πy ch·ªânh `buffer size`, `period size`, `format`, `sample rate`.
- ƒê·∫£m b·∫£o ch·∫•t l∆∞·ª£ng √¢m thanh cao cho c·∫£ ng∆∞·ªùi d√πng v√† nh√† ph√°t tri·ªÉn ph·∫ßn m·ªÅm √¢m thanh.

V√≠ d·ª• Ghi √¢m 10 gi√¢y v·ªõi ch·∫•t l∆∞·ª£ng CD (44.1 kHz, 16-bit, stereo):
```
arecord -d 10 -f cd -t wav myrecording.wav
```
### üéöÔ∏è Mixer Interface

Giao di·ªán mixer cho ph√©p ƒëi·ªÅu ch·ªânh c√°c th√¥ng s·ªë ƒë·∫ßu v√†o/ra:

- ƒêi·ªÅu ch·ªânh volume t·ªïng, √¢m l∆∞·ª£ng t·ª´ng k√™nh, b·∫≠t/t·∫Øt mute,...
- ƒêi·ªÅu khi·ªÉn routing gi·ªØa c√°c ngu·ªìn √¢m thanh (mic, line-in, speaker,...).
- C√≥ th·ªÉ truy c·∫≠p qua CLI (`amixer`, `alsamixer`) ho·∫∑c l·∫≠p tr√¨nh th√¥ng qua `alsa-lib`.

Kh·ªüi ƒë·ªông tr√¨nh mixer d·∫°ng GUI:
```
alsamixer
```
### üéº MIDI Support

ALSA h·ªó tr·ª£ MIDI (Musical Instrument Digital Interface) cho c√°c ·ª©ng d·ª•ng s·∫£n xu·∫•t nh·∫°c.

- Cho ph√©p giao ti·∫øp v·ªõi nh·∫°c c·ª• ƒëi·ªán t·ª≠, synthesizer,...
- X·ª≠ l√Ω s·ª± ki·ªán MIDI th·ªùi gian th·ª±c.
- L√† n·ªÅn t·∫£ng cho c√°c ph·∫ßn m·ªÅm nh∆∞ FluidSynth, TiMidity++, Rosegarden,...


Li·ªát k√™ thi·∫øt b·ªã MIDI:
```
aconnect -l
```
### üß© Plug-In System

ALSA h·ªó tr·ª£ h·ªá th·ªëng plugin √¢m thanh ·ªü user space.

- Cho ph√©p th·ª±c hi·ªán `resampling`, `format conversion`, `equalizer`, v√† c√°c hi·ªáu ·ª©ng s·ªë kh√°c.
- C√≥ th·ªÉ t·∫°o c·∫•u h√¨nh `.asoundrc` ƒë·ªÉ thi·∫øt l·∫≠p chu·ªói x·ª≠ l√Ω √¢m thanh logic.
- C·∫ßn thi·∫øt cho c√°c thi·∫øt b·ªã kh√¥ng h·ªó tr·ª£ ph·∫ßn c·ª©ng tr·ªôn ho·∫∑c ƒë·ªãnh d·∫°ng kh√¥ng t∆∞∆°ng th√≠ch.


### ‚öôÔ∏è Efficient Sound Processing

ALSA cung c·∫•p kh·∫£ nƒÉng x·ª≠ l√Ω √¢m thanh hi·ªáu qu·∫£ v√† ƒë·ªô tr·ªÖ th·∫•p:

- Ph√π h·ª£p v·ªõi c√°c ·ª©ng d·ª•ng chuy√™n nghi·ªáp c·∫ßn real-time audio nh∆∞ DAW, livestream,...
- T·ªëi ∆∞u cho c√°c n·ªÅn t·∫£ng nh√∫ng v·ªõi t√†i nguy√™n gi·ªõi h·∫°n.
- Cho ph√©p ƒëi·ªÅu ch·ªânh th√¥ng s·ªë buffer ƒë·ªÉ c√¢n b·∫±ng gi·ªØa hi·ªáu nƒÉng v√† ƒë·ªô tr·ªÖ.

Ki·ªÉm tra th√¥ng s·ªë buffer hi·ªán t·∫°i:
```
cat /proc/asound/card0/pcm0p/sub0/hw_params
```
---

---
## ‚öôÔ∏è Custom ALSA codec driver from scratch 

### C·∫•u tr√∫c c√¢y th∆∞ m·ª•c

```

project-root/
‚îú‚îÄ‚îÄ sound/
‚îÇ   ‚îî‚îÄ‚îÄ soc/
‚îÇ       ‚îú‚îÄ‚îÄ codecs/
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ mycodec.c         ‚Üê Driver codec ch√≠nh (kernel)
‚îÇ       ‚îî‚îÄ‚îÄ boards/
‚îÇ           ‚îî‚îÄ‚îÄ my_machine.c      ‚Üê Machine driver k·∫øt n·ªëi SoC v√† codec
‚îú‚îÄ‚îÄ arch/
‚îÇ   ‚îî‚îÄ‚îÄ arm/boot/dts/
‚îÇ       ‚îî‚îÄ‚îÄ my_board.dts          ‚Üê Device Tree cho board t√πy ch·ªânh
‚îú‚îÄ‚îÄ user/
‚îÇ   ‚îî‚îÄ‚îÄ alsa_play.cpp             ‚Üê Ch∆∞∆°ng tr√¨nh test ph√°t √¢m thanh (user space)

```

Simple source n·∫±m trong [simple alsa codec driver](./simple_alsa_codec_driver)

---
### Ch·ª©c nƒÉng t·ª´ng file

#### üìÑ `mycodec.c` ‚Äì Codec Driver

| Th√†nh ph·∫ßn | M√¥ t·∫£ |
|------------|------|
| `my_codec_controls` | ƒê·ªãnh nghƒ©a mixer control, v√≠ d·ª• volume. |
| `my_codec_widgets` | Khai b√°o c√°c DAPM widgets nh∆∞ `IN`, `OUT`. |
| `my_codec_routes` | X√°c ƒë·ªãnh ƒë∆∞·ªùng ƒëi t√≠n hi·ªáu √¢m thanh gi·ªØa widgets. |
| `my_codec_dai` | M√¥ t·∫£ giao ti·∫øp DAI c·ªßa codec: format, rate, channel. |
| `my_codec_driver` | G·∫Øn c√°c controls, widgets, routes v√†o codec component. |
| `my_codec_probe` | H√†m kh·ªüi t·∫°o codec driver, in log ho·∫∑c kh·ªüi t·∫°o codec. |
| `my_codec_i2c_probe` | ƒêƒÉng k√Ω codec driver v·ªõi ALSA qua I2C. |
| `module_i2c_driver()` | ƒêƒÉng k√Ω module codec v·ªõi kernel th√¥ng qua h·ªá th·ªëng driver. |

#### üìÑ `my_machine.c` ‚Äì Machine Driver

| Th√†nh ph·∫ßn | M√¥ t·∫£ |
|------------|------|
| `my_dai_link` | Li√™n k·∫øt gi·ªØa CPU DAI ‚Üî Codec DAI (I2S). |
| `my_snd_card` | ƒê·∫°i di·ªán cho sound card ALSA, ch·ª©a `dai_link`. |
| `my_machine_probe` | ƒêƒÉng k√Ω sound card v·ªõi kernel th√¥ng qua `snd_soc_register_card()`. |
| `module_platform_driver()` | ƒêƒÉng k√Ω machine driver theo chu·∫©n platform. |

#### üìÑ `my_board.dts` ‚Äì Device Tree

| Th√†nh ph·∫ßn | M√¥ t·∫£ |
|------------|------|
| `mycodec@1a` | Codec ƒë∆∞·ª£c k·∫øt n·ªëi qua I2C1 v·ªõi ƒë·ªãa ch·ªâ `0x1a`. |
| `compatible = "mycompany,mycodec"` | T√™n ƒë·ªãnh danh tr·ªè t·ªõi codec driver. |
| `&sound` | Node ƒë·ªãnh nghƒ©a sound card. |
| `cpu { sound-dai = <&i2s0>; }` | Ch·ªâ ƒë·ªãnh DAI interface c·ªßa CPU (I2S0, McASP0‚Ä¶). |
| `codec { sound-dai = <&mycodec>; }` | Li√™n k·∫øt ƒë·∫øn codec DAI ƒë√£ khai b√°o. |
| `dais { dai-format = "i2s"; ... }` | C·∫•u h√¨nh ƒë·ªãnh d·∫°ng giao ti·∫øp √¢m thanh (I2S), master/slave. |

#### üìÑ `alsa_play.cpp` ‚Äì ·ª®ng d·ª•ng ALSA ƒë·ªÉ Test Ph√°t √Çm Thanh

| Th√†nh ph·∫ßn | M√¥ t·∫£ |
|------------|------|
| `snd_pcm_open()` | M·ªü thi·∫øt b·ªã ph√°t √¢m thanh `hw:0,0` (card 0, device 0). |
| `snd_pcm_set_params()` | C·∫•u h√¨nh: format (S16_LE), 2 k√™nh stereo, 44.1kHz, buffer time. |
| `fread() + snd_pcm_writei()` | ƒê·ªçc d·ªØ li·ªáu t·ª´ file WAV v√† g·ª≠i ƒë·∫øn codec. |
| `snd_pcm_close()` | ƒê√≥ng thi·∫øt b·ªã sau khi ph√°t xong. |

- Th·ª±c hi·ªán build file.ko t∆∞∆°ng ·ª©ng v√† insmod c√°c file v√†o h·ªá th·ªëng.

```
sudo insmod ./sound/soc/codecs/mycodec.ko
sudo insmod ./sound/soc/boards/my_machine.ko
```

- Ki·ªÉm tra ALSA nh·∫≠n card ch∆∞a

```
aplay -l    # Li·ªát k√™ c√°c thi·∫øt b·ªã playback
arecord -l  # Li·ªát k√™ c√°c thi·∫øt b·ªã record
```
- Ki·ªÉm tra kernel logs
```
dmesg | grep snd
dmesg | grep mycodec
```
- Ki·ªÉm tra th√¥ng tin card
```
cat /proc/asound/cards
```
- Ph√°t th·ª≠ b·∫±ng aplay
```
aplay -D hw:0,0 test.wav
```
---
## üìå K·∫øt lu·∫≠n
H·ªá th·ªëng ALSA trong kh√¥ng gian kernel cung c·∫•p m·ªôt ki·∫øn tr√∫c √¢m thanh m·∫°nh m·∫Ω v√† m√¥-ƒëun cho Linux, ƒë·∫∑c bi·ªát ph√π h·ª£p v·ªõi c√°c thi·∫øt b·ªã nh√∫ng (embedded) v√† SoC. V·ªõi m√¥ h√¨nh ASoC (ALSA System-on-Chip), driver √¢m thanh ƒë∆∞·ª£c t√°ch th√†nh ba ph·∫ßn r√µ r√†ng: **codec driver** ƒë·ªÉ ƒëi·ªÅu khi·ªÉn chip ADC/DAC, **CPU Dai** ƒë·ªÉ x·ª≠ l√Ω DMA v√† t∆∞∆°ng t√°c ph·∫ßn c·ª©ng, v√† **machine driver** ƒë·ªÉ k·∫øt n·ªëi hai th√†nh ph·∫ßn tr√™n theo ƒë·∫∑c t·∫£ ph·∫ßn c·ª©ng c·ª• th·ªÉ. C·∫•u h√¨nh ph·∫ßn c·ª©ng ƒë∆∞·ª£c ho√†n thi·ªán th√¥ng qua Device Tree, gi√∫p t√°ch bi·ªát logic ph·∫ßn c·ª©ng ra kh·ªèi m√£ ngu·ªìn driver. Nh·ªù ƒë√≥, ALSA trong kernel space kh√¥ng ch·ªâ ƒë·∫£m b·∫£o hi·ªáu nƒÉng v√† t√≠nh ·ªïn ƒë·ªãnh cao m√† c√≤n d·ªÖ d√†ng m·ªü r·ªông v√† t√πy bi·∫øn cho nhi·ªÅu lo·∫°i thi·∫øt b·ªã √¢m thanh kh√°c nhau.