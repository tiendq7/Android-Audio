# üéµ ALSA trong Kernel Space
Trong h·ªá th·ªëng Audio c·ªßa Android, t·∫ßng kernel ƒë√≥ng vai tr√≤ quan tr·ªçng trong vi·ªác k·∫øt n·ªëi ph·∫ßn m·ªÅm v·ªõi ph·∫ßn c·ª©ng √¢m thanh. Nh∆∞ ƒë√£ ƒë∆∞·ª£c tr√¨nh b√†y trong s∆° ƒë·ªì [Overview](./Overview_Android_Audio.md) **T·ªïng quan h·ªá th·ªëng Audio trong Android** ‚Äî t·ª´ Application nh∆∞ Media Player hay Media Recorder ‚Äî s·∫Ω l·∫ßn l∆∞·ª£t ƒëi qua c√°c l·ªõp framework, JNI, native library, c√°c service nh∆∞ AudioFlinger v√† AudioPolicy trong Media Server, sau ƒë√≥ truy·ªÅn xu·ªëng l·ªõp HAL (Hardware Abstraction Layer) v√† cu·ªëi c√πng l√† **Linux Kernel**. Ch√≠nh t·∫°i t·∫ßng kernel n√†y, audio driver s·∫Ω ƒë·∫£m nh·∫≠n nhi·ªám v·ª• giao ti·∫øp tr·ª±c ti·∫øp v·ªõi ph·∫ßn c·ª©ng nh∆∞ b·ªô m√£ h√≥a/gi·∫£i m√£ √¢m thanh (codec), giao ti·∫øp I2S/PCM, ADC/DAC‚Ä¶

Tr√™n Linux, c√≥ hai ki·∫øn tr√∫c audio ph·ªï bi·∫øn t·ª´ng ƒë∆∞·ª£c s·ª≠ d·ª•ng l√† **OSS (Open Sound System)** v√† **ALSA (Advanced Linux Sound Architecture)**. OSS l√† h·ªá th·ªëng √¢m thanh ban ƒë·∫ßu trong Linux, nh∆∞ng n√≥ b·ªôc l·ªô nhi·ªÅu h·∫°n ch·∫ø nh∆∞ thi·∫øu kh·∫£ nƒÉng m·ªü r·ªông, thi·∫øu h·ªó tr·ª£ mixer control v√† kh√≥ t√≠ch h·ª£p v·ªõi c√°c y√™u c·∫ßu ph·ª©c t·∫°p c·ªßa ph·∫ßn c·ª©ng hi·ªán ƒë·∫°i. Trong khi ƒë√≥, ALSA ƒë∆∞·ª£c thi·∫øt k·∫ø ƒë·ªÉ thay th·∫ø OSS v·ªõi kh·∫£ nƒÉng h·ªó tr·ª£ t·ªët h∆°n cho card √¢m thanh hi·ªán ƒë·∫°i, cho ph√©p qu·∫£n l√Ω nhi·ªÅu thi·∫øt b·ªã c√πng l√∫c, c√≥ giao di·ªán l·∫≠p tr√¨nh phong ph√∫, h·ªó tr·ª£ mixer, control,... v√† kh·∫£ nƒÉng t√≠ch h·ª£p cao v·ªõi c√°c h·ªá th·ªëng nh∆∞ Android.

V√¨ nh·ªØng l√Ω do ƒë√≥, ng√†y nay ALSA tr·ªü th√†nh ki·∫øn tr√∫c ch√≠nh ƒë∆∞·ª£c s·ª≠ d·ª•ng trong ph·∫ßn l·ªõn thi·∫øt b·ªã Android. Audio HAL c·ªßa Android th∆∞·ªùng √°nh x·∫° xu·ªëng ALSA driver trong kernel, v√† t·ª´ ƒë√≥ t∆∞∆°ng t√°c tr·ª±c ti·∫øp v·ªõi ph·∫ßn c·ª©ng codec, I2S hay c√°c m·∫°ch x·ª≠ l√Ω t√≠n hi·ªáu √¢m thanh.

Trong ch∆∞∆°ng n√†y, ch√∫ng ta s·∫Ω t·∫≠p trung ho√†n to√†n v√†o ALSA ·ªü t·∫ßng kernel space, ƒë·∫∑c bi·ªát l√† ki·∫øn tr√∫c ASoC (ALSA System on Chip), v·ªën ƒë∆∞·ª£c thi·∫øt k·∫ø ri√™ng ƒë·ªÉ h·ªó tr·ª£ c√°c n·ªÅn t·∫£ng nh√∫ng nh∆∞ smartphone, tablet ho·∫∑c board nh√∫ng nh∆∞ BeagleBone, STM32 hay Raspberry Pi.

## üîç ALSA l√† g√¨? (Advanced Linux Sound Architecture)

**ALSA (Advanced Linux Sound Architecture)** l√† m·ªôt framework √¢m thanh v√† l√† m·ªôt ph·∫ßn c·ªßa **nh√¢n Linux**, cung c·∫•p ch·ª©c nƒÉng **x·ª≠ l√Ω √¢m thanh (audio)** v√† **MIDI** cho c√°c h·ªá th·ªëng d·ª±a tr√™n Linux.

C·ª• th·ªÉ, ALSA ƒë·∫£m nhi·ªám c√°c vai tr√≤ sau:

- Giao ti·∫øp tr·ª±c ti·∫øp v·ªõi **driver thi·∫øt b·ªã √¢m thanh**
- Qu·∫£n l√Ω qu√° tr√¨nh **x·ª≠ l√Ω t√≠n hi·ªáu √¢m thanh**
- L√† c·∫ßu n·ªëi gi·ªØa **h·ªá ƒëi·ªÅu h√†nh** v√† **ph·∫ßn c·ª©ng √¢m thanh**

V·ªõi ALSA, h·ªá ƒëi·ªÅu h√†nh Linux c√≥ th·ªÉ:

- Thu v√† ph√°t √¢m thanh th√¥ng qua card √¢m thanh
- ƒêi·ªÅu khi·ªÉn mixer v√† √¢m l∆∞·ª£ng
- G·ª≠i v√† nh·∫≠n t√≠n hi·ªáu MIDI
- H·ªó tr·ª£ ƒë·ªìng th·ªùi nhi·ªÅu thi·∫øt b·ªã √¢m thanh

üîß V√¨ ƒë∆∞·ª£c t√≠ch h·ª£p tr·ª±c ti·∫øp trong nh√¢n, ALSA cho ph√©p truy c·∫≠p √¢m thanh v·ªõi **hi·ªáu nƒÉng cao**, h·ªó tr·ª£ **x·ª≠ l√Ω th·ªùi gian th·ª±c** v√† kh·∫£ nƒÉng m·ªü r·ªông ƒë·∫øn **nhi·ªÅu thi·∫øt b·ªã** c√πng l√∫c.

---
## ‚öôÔ∏è C·∫•u tr√∫c driver ALSA trong nh√¢n Linux

![alt text](alsa_overview.png)

Driver ALSA trong Linux ƒë∆∞·ª£c t·ªï ch·ª©c th√†nh nh∆∞ h√¨nh tr√™n, t·ª´ kh√¥ng gian ng∆∞·ªùi d√πng (user space) cho ƒë·∫øn ph·∫ßn c·ª©ng (hardware). M·ªói t·∫ßng ƒë√≥ng m·ªôt vai tr√≤ quan tr·ªçng trong vi·ªác truy·ªÅn v√† x·ª≠ l√Ω d·ªØ li·ªáu √¢m thanh, ƒë·ªìng th·ªùi b·∫£o ƒë·∫£m t√≠nh linh ho·∫°t v√† kh·∫£ nƒÉng m·ªü r·ªông cho c√°c h·ªá th·ªëng kh√°c nhau, ƒë·∫∑c bi·ªát trong m√¥i tr∆∞·ªùng nh√∫ng nh∆∞ Android, Raspberry Pi ho·∫∑c c√°c SoC.


### 1. User Space

L·ªõp tr√™n c√πng c·ªßa h·ªá th·ªëng ALSA l√† kh√¥ng gian ng∆∞·ªùi d√πng, n∆°i c√°c ·ª©ng d·ª•ng t∆∞∆°ng t√°c v·ªõi h·ªá th·ªëng √¢m thanh th√¥ng qua th∆∞ vi·ªán ALSA:

- **Client Application**: Bao g·ªìm c√°c ·ª©ng d·ª•ng nh∆∞ `aplay`, `arecord`, `VLC`, ho·∫∑c c√°c ·ª©ng d·ª•ng C/C++ t√πy bi·∫øn. C√°c ·ª©ng d·ª•ng n√†y s·ª≠ d·ª•ng API ALSA ƒë·ªÉ ph√°t ho·∫∑c thu √¢m thanh.
- **alsa-utils**: T·∫≠p h·ª£p c√°c c√¥ng c·ª• d√≤ng l·ªánh gi√∫p ki·ªÉm tra v√† ƒëi·ªÅu khi·ªÉn thi·∫øt b·ªã √¢m thanh.
- **alsa-lib (libasound)**: Th∆∞ vi·ªán ng∆∞·ªùi d√πng trung gian gi·ªØa ·ª©ng d·ª•ng v√† kernel, cung c·∫•p c√°c API nh∆∞ `snd_pcm_*`, `snd_ctl_*`, `snd_mixer_*` ƒë·ªÉ thao t√°c v·ªõi thi·∫øt b·ªã √¢m thanh th√¥ng qua node `/dev/snd/*`.

### 2. ALSA Kernel Framework

ƒê√¢y l√† ph·∫ßn c·ªët l√µi c·ªßa ALSA n·∫±m trong nh√¢n Linux, ch·ªãu tr√°ch nhi·ªám x·ª≠ l√Ω ch√≠nh c√°c ho·∫°t ƒë·ªông li√™n quan ƒë·∫øn stream √¢m thanh:

- **PCM (Pulse Code Modulation)**: Qu·∫£n l√Ω lu·ªìng d·ªØ li·ªáu √¢m thanh k·ªπ thu·∫≠t s·ªë. Th√¥ng qua c√°c buffer v√† c∆° ch·∫ø DMA, PCM cho ph√©p ph√°t (`playback`) v√† thu (`capture`) √¢m thanh.
- **Control Interface**: Cho ph√©p truy c·∫≠p c√°c th√†nh ph·∫ßn ƒëi·ªÅu khi·ªÉn nh∆∞ volume, mute, gain ho·∫∑c mixer. Th√¥ng tin ƒëi·ªÅu khi·ªÉn ƒë∆∞·ª£c √°nh x·∫° qua giao di·ªán `/dev/snd/controlC*`.

### 3. ASoC ‚Äì ALSA System on Chip

ƒê·ªÉ h·ªó tr·ª£ c√°c h·ªá th·ªëng nh√∫ng, ALSA ƒë∆∞·ª£c m·ªü r·ªông v·ªõi l·ªõp ASoC. L·ªõp n√†y gi√∫p t√°ch bi·ªát ph·∫ßn m·ªÅm v√† ph·∫ßn c·ª©ng b·∫±ng c√°ch ƒë·ªãnh nghƒ©a c√°c giao di·ªán chung gi·ªØa CPU v√† codec √¢m thanh:

- **soc-core**: Th√†nh ph·∫ßn trung t√¢m c·ªßa ASoC, ch·ªãu tr√°ch nhi·ªám li√™n k·∫øt c√°c driver CPU, codec v√† machine driver. ƒê·ªìng th·ªùi, qu·∫£n l√Ω c·∫•u tr√∫c thi·∫øt b·ªã √¢m thanh th√¥ng qua khung `snd_soc_card`.
- **pcm-dmaengine**: Driver cho c∆° ch·∫ø truy·ªÅn d·ªØ li·ªáu √¢m thanh t·ª´ b·ªô nh·ªõ ƒë·∫øn ph·∫ßn c·ª©ng th√¥ng qua DMA, gi·∫£m t·∫£i cho CPU.
- **DAPM (Dynamic Audio Power Management)**: H·ªá th·ªëng qu·∫£n l√Ω nƒÉng l∆∞·ª£ng ƒë·ªông gi√∫p t·ª± ƒë·ªông b·∫≠t/t·∫Øt c√°c ph·∫ßn t·ª≠ √¢m thanh kh√¥ng c·∫ßn thi·∫øt nh·∫±m ti·∫øt ki·ªám ƒëi·ªán nƒÉng.

### 4. ASoC Drivers

L·ªõp n√†y ch·ª©a c√°c driver t∆∞∆°ng ·ª©ng v·ªõi ph·∫ßn c·ª©ng c·ª• th·ªÉ c·ªßa n·ªÅn t·∫£ng:

- **Machine Driver**: ƒê·ªãnh nghƒ©a c·∫•u tr√∫c k·∫øt n·ªëi c·ª• th·ªÉ cho t·ª´ng board (v√≠ d·ª•: Raspberry Pi, BeagleBone). Thi·∫øt l·∫≠p ƒë∆∞·ªùng ƒëi t√≠n hi·ªáu gi·ªØa CPU ‚Üî Codec ‚Üî Loa/Mic.
- **CPU DAI Driver (Digital Audio Interface)**: ƒêi·ªÅu khi·ªÉn giao ti·∫øp s·ªë nh∆∞ I2S, PCM, TDM. ƒê∆∞·ª£c √°nh x·∫° t·ªõi c√°c ph·∫ßn t·ª≠ ph·∫ßn c·ª©ng nh∆∞ b·ªô ƒëi·ªÅu khi·ªÉn √¢m thanh trong SoC.
- **Codec Driver**: Giao ti·∫øp v·ªõi chip codec v·∫≠t l√Ω th√¥ng qua I2C ho·∫∑c SPI, c·∫•u h√¨nh c√°c th√¥ng s·ªë nh∆∞ volume, gain, sampling rate,‚Ä¶

### 5. Hardware

T·∫ßng d∆∞·ªõi c√πng l√† c√°c th√†nh ph·∫ßn v·∫≠t l√Ω bao g·ªìm:

- **CPU DAI Peripheral**: Kh·ªëi ph·∫ßn c·ª©ng trong SoC ch·ªãu tr√°ch nhi·ªám g·ª≠i/nh·∫≠n d·ªØ li·ªáu √¢m thanh s·ªë (I2S, PCM...).
- **Codec ho·∫∑c Audio Connector**: IC chuy·ªÉn ƒë·ªïi t√≠n hi·ªáu s·ªë ‚Üî analog (DAC/ADC), ho·∫∑c c√°c ƒë·∫ßu k·∫øt n·ªëi v·ªõi loa, micro ho·∫∑c tai nghe.
  
---

## üéß Features of ALSA (Advanced Linux Sound Architecture) in Linux

ALSA l√† n·ªÅn t·∫£ng √¢m thanh ch√≠nh th·ª©c trong Linux kernel, cung c·∫•p giao di·ªán c·∫•p th·∫•p ƒë·ªÉ giao ti·∫øp v·ªõi ph·∫ßn c·ª©ng √¢m thanh. D∆∞·ªõi ƒë√¢y l√† c√°c t√≠nh nƒÉng n·ªïi b·∫≠t c·ªßa ALSA:

### üîå Low-Level Hardware Access

ALSA t∆∞∆°ng t√°c tr·ª±c ti·∫øp v·ªõi ph·∫ßn c·ª©ng √¢m thanh th√¥ng qua c√°c kernel driver m√† kh√¥ng c·∫ßn th√¥ng qua c√°c t·∫ßng tr·ª´u t∆∞·ª£ng trung gian.

- Gi√∫p gi·∫£m ƒë·ªô tr·ªÖ √¢m thanh (low-latency).
- Cho ph√©p truy c·∫≠p v√† c·∫•u h√¨nh chi ti·∫øt c√°c tham s·ªë ph·∫ßn c·ª©ng nh∆∞ `bit depth`, `sample rate`, `channel layout`.
- H·ªØu √≠ch cho vi·ªác ph√°t tri·ªÉn driver t√πy ch·ªânh cho thi·∫øt b·ªã √¢m thanh m·ªõi.
  
Ki·ªÉm tra danh s√°ch c√°c sound card ƒë∆∞·ª£c h·ªá th·ªëng nh·∫≠n di·ªán:
```
cat /proc/asound/cards
```
### üéõÔ∏è Multiple Sound Card Support

ALSA c√≥ kh·∫£ nƒÉng qu·∫£n l√Ω ƒë·ªìng th·ªùi nhi·ªÅu sound card trong m·ªôt h·ªá th·ªëng.

- Ng∆∞·ªùi d√πng c√≥ th·ªÉ ch·ªçn card n√†o ƒë·ªÉ playback ho·∫∑c record.
- H·ªó tr·ª£ t·ªët cho h·ªá th·ªëng c√≥ c·∫£ sound card t√≠ch h·ª£p v√† USB.
- Cung c·∫•p kh·∫£ nƒÉng ƒë·ªãnh tuy·∫øn √¢m thanh gi·ªØa c√°c thi·∫øt b·ªã kh√°c nhau.

Li·ªát k√™ t·∫•t c·∫£ c√°c thi·∫øt b·ªã √¢m thanh:
```
aplay -l
```
### üéôÔ∏è PCM (Pulse Code Modulation) Support

ALSA h·ªó tr·ª£ PCM ‚Äî chu·∫©n ƒë·ªãnh d·∫°ng √¢m thanh s·ªë ph·ªï bi·∫øn nh·∫•t hi·ªán nay.

- Cho ph√©p playback v√† recording ·ªü nhi·ªÅu c·∫•u h√¨nh: mono, stereo, multichannel.
- H·ªó tr·ª£ t√πy ch·ªânh `buffer size`, `period size`, `format`, `sample rate`.
- ƒê·∫£m b·∫£o ch·∫•t l∆∞·ª£ng √¢m thanh cao cho c·∫£ ng∆∞·ªùi d√πng v√† nh√† ph√°t tri·ªÉn ph·∫ßn m·ªÅm √¢m thanh.

V√≠ d·ª• Ghi √¢m 10 gi√¢y v·ªõi ch·∫•t l∆∞·ª£ng CD (44.1 kHz, 16-bit, stereo):
```
arecord -d 10 -f cd -t wav myrecording.wav
```
### üéöÔ∏è Mixer Interface

Giao di·ªán mixer cho ph√©p ƒëi·ªÅu ch·ªânh c√°c th√¥ng s·ªë ƒë·∫ßu v√†o/ra:

- ƒêi·ªÅu ch·ªânh volume t·ªïng, √¢m l∆∞·ª£ng t·ª´ng k√™nh, b·∫≠t/t·∫Øt mute,...
- ƒêi·ªÅu khi·ªÉn routing gi·ªØa c√°c ngu·ªìn √¢m thanh (mic, line-in, speaker,...).
- C√≥ th·ªÉ truy c·∫≠p qua CLI (`amixer`, `alsamixer`) ho·∫∑c l·∫≠p tr√¨nh th√¥ng qua `alsa-lib`.

Kh·ªüi ƒë·ªông tr√¨nh mixer d·∫°ng GUI:
```
alsamixer
```
### üéº MIDI Support

ALSA h·ªó tr·ª£ MIDI (Musical Instrument Digital Interface) cho c√°c ·ª©ng d·ª•ng s·∫£n xu·∫•t nh·∫°c.

- Cho ph√©p giao ti·∫øp v·ªõi nh·∫°c c·ª• ƒëi·ªán t·ª≠, synthesizer,...
- X·ª≠ l√Ω s·ª± ki·ªán MIDI th·ªùi gian th·ª±c.
- L√† n·ªÅn t·∫£ng cho c√°c ph·∫ßn m·ªÅm nh∆∞ FluidSynth, TiMidity++, Rosegarden,...


Li·ªát k√™ thi·∫øt b·ªã MIDI:
```
aconnect -l
```
### üß© Plug-In System

ALSA h·ªó tr·ª£ h·ªá th·ªëng plugin √¢m thanh ·ªü user space.

- Cho ph√©p th·ª±c hi·ªán `resampling`, `format conversion`, `equalizer`, v√† c√°c hi·ªáu ·ª©ng s·ªë kh√°c.
- C√≥ th·ªÉ t·∫°o c·∫•u h√¨nh `.asoundrc` ƒë·ªÉ thi·∫øt l·∫≠p chu·ªói x·ª≠ l√Ω √¢m thanh logic.
- C·∫ßn thi·∫øt cho c√°c thi·∫øt b·ªã kh√¥ng h·ªó tr·ª£ ph·∫ßn c·ª©ng tr·ªôn ho·∫∑c ƒë·ªãnh d·∫°ng kh√¥ng t∆∞∆°ng th√≠ch.


### ‚öôÔ∏è Efficient Sound Processing

ALSA cung c·∫•p kh·∫£ nƒÉng x·ª≠ l√Ω √¢m thanh hi·ªáu qu·∫£ v√† ƒë·ªô tr·ªÖ th·∫•p:

- Ph√π h·ª£p v·ªõi c√°c ·ª©ng d·ª•ng chuy√™n nghi·ªáp c·∫ßn real-time audio nh∆∞ DAW, livestream,...
- T·ªëi ∆∞u cho c√°c n·ªÅn t·∫£ng nh√∫ng v·ªõi t√†i nguy√™n gi·ªõi h·∫°n.
- Cho ph√©p ƒëi·ªÅu ch·ªânh th√¥ng s·ªë buffer ƒë·ªÉ c√¢n b·∫±ng gi·ªØa hi·ªáu nƒÉng v√† ƒë·ªô tr·ªÖ.

Ki·ªÉm tra th√¥ng s·ªë buffer hi·ªán t·∫°i:
```
cat /proc/asound/card0/pcm0p/sub0/hw_params
```

---
## ‚öôÔ∏è Custom ALSA codec driver from scratch 

### 1.Demo codec driver.

```

project-root/
‚îú‚îÄ‚îÄ sound/
‚îÇ   ‚îî‚îÄ‚îÄ soc/
‚îÇ       ‚îú‚îÄ‚îÄ codecs/
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ mycodec.c         ‚Üê Driver codec ch√≠nh (kernel)
‚îÇ       ‚îî‚îÄ‚îÄ boards/
‚îÇ           ‚îî‚îÄ‚îÄ my_machine.c      ‚Üê Machine driver k·∫øt n·ªëi SoC v√† codec
‚îú‚îÄ‚îÄ arch/
‚îÇ   ‚îî‚îÄ‚îÄ arm/boot/dts/
‚îÇ       ‚îî‚îÄ‚îÄ my_board.dts          ‚Üê Device Tree cho board t√πy ch·ªânh
‚îú‚îÄ‚îÄ user/
‚îÇ   ‚îî‚îÄ‚îÄ alsa_play.cpp             ‚Üê Ch∆∞∆°ng tr√¨nh test ph√°t √¢m thanh (user space)

```

Simple source n·∫±m trong [simple alsa codec driver](./simple_alsa_codec_driver)

---
#### Lu·ªìng ho·∫°t ƒë·ªông t·ªïng th·ªÉ

Quy tr√¨nh kh·ªüi t·∫°o v√† ho·∫°t ƒë·ªông c·ªßa h·ªá th·ªëng ASoC v·ªõi codec gi·∫£ ƒë·ªãnh `mycodec` di·ªÖn ra theo c√°c b∆∞·ªõc sau:

1. **Kernel kh·ªüi ƒë·ªông**  
   Trong qu√° tr√¨nh boot, kernel ƒë·ªçc Device Tree v√† ph√°t hi·ªán node `mycodec@1a` tr√™n bus I¬≤C.  
   ‚Üí I¬≤C core k√≠ch ho·∫°t h√†m `mycodec_i2c_probe()`, t·ª´ ƒë√≥ codec driver ƒë∆∞·ª£c ƒëƒÉng k√Ω v√†o ASoC core.

2. **Kh·ªüi t·∫°o machine driver t·ª´ Device Tree `sound`**  
   Kernel ti·∫øp t·ª•c d√≤ node `sound` trong Device Tree v√† match v·ªõi `my-machine` driver.  
   ‚Üí H√†m `my_machine_probe()` ƒë∆∞·ª£c g·ªçi, t·∫°o ra m·ªôt `snd_soc_card` c√πng c√°c `snd_soc_dai_link` m√¥ t·∫£ m·ªëi li√™n h·ªá gi·ªØa CPU DAI v√† codec DAI.

3. **ASoC core gh√©p n·ªëi DAI**  
   ASoC core s·ª≠ d·ª•ng th√¥ng tin t·ª´ `snd_soc_dai_link` ƒë·ªÉ k·∫øt n·ªëi:  
   - **CPU DAI**: driver `bcm2835-i2s` (ph·∫ßn t·ª≠ I¬≤S trong SoC).  
   - **Codec DAI**: driver `mycodec-dai` (ƒë∆∞·ª£c ƒëƒÉng k√Ω t·ª´ codec driver).  
   ‚Üí T·∫°o ra th·ª±c th·ªÉ `pcm_runtime` cho card √¢m thanh.

4. **ALSA t·∫°o thi·∫øt b·ªã trong user space**  
   Khi card ƒë√£ ƒë∆∞·ª£c c·∫•u h√¨nh xong, ALSA s·∫Ω ƒëƒÉng k√Ω thi·∫øt b·ªã √¢m thanh m·ªõi.  
   ‚Üí Ng∆∞·ªùi d√πng c√≥ th·ªÉ th·∫•y card b·∫±ng l·ªánh `aplay -l` ho·∫∑c `arecord -l`.  
   ‚Üí T·ª´ ƒë√≥, c√°c ·ª©ng d·ª•ng user space c√≥ th·ªÉ g·ªçi `aplay` (ph√°t nh·∫°c) ho·∫∑c `arecord` (ghi √¢m) th√¥ng qua thi·∫øt b·ªã `/dev/snd/pcmCxDy[p|c]`.

- Th·ª±c hi·ªán build file.ko t∆∞∆°ng ·ª©ng v√† insmod c√°c file v√†o h·ªá th·ªëng.

---
### 2. WM8960 codec driver 
Ti·∫øp theo ch√∫ng ta s·∫Ω ƒëi ƒë·∫øn 1 v√≠ d·ª• v·ªÅ vi·ªác tri·ªÉn khai 1 Codec Driver c·ª• th·ªÉ. ·ªû ƒë√¢y l√† vi·ªác tri·ªÉn khai WM8960 v·ªõi Raspbery Pi 4. Nh∆∞ ƒë√£ m√¥ t·∫£ ·ªü ph√≠a tr√™n v·ªÅ  ph·∫ßn **ASoC Drivers** , tr√™n n·ªÅn t·∫£ng **Raspberry Pi 4 v·ªõi codec WM8960**, c√°c driver ƒë∆∞·ª£c √°nh x·∫° c·ª• th·ªÉ nh∆∞ sau:
- **CPU DAI Driver**: `bcm2835-i2s`
- **Codec Driver**: `wm8960` (`snd-soc-wm8960`)  
- **Machine Driver**: `simple-audio-card`
Source code: https://github.com/waveshareteam/WM8960-Audio-HAT

#### Lu·ªìng ho·∫°t ƒë·ªông t·ªïng th·ªÉ

```mermaid
graph TD
  subgraph DeviceTree
    DT_cpu_i2s["cpu_i2s (DT node)"]
    DT_codec["codec (DT node)"]
    DT_simple_audio_card["simple-audio-card (DT node)"]
    DT_fixed_clock["fixed_clock (DT node)"]
  end

  subgraph Drivers
    cpu_dai_driver["CPU DAI Driver (bcm2835-i2s)"]
    machine_driver_simple_card["Machine Driver (simple-card)"]
    codec_driver["Codec Driver (wm8960)"]
    platform_driver["Platform Driver (bcm2835-pcm)"]
  end

  subgraph ASOC_Core["ASoC Core"]
    snd_soc_card["snd_soc_card"]
    snd_soc_dai_link["snd_soc_dai_link"]
    dai_link_cpu["dai_link.cpus[0]"]
    dai_link_codec["dai_link.codecs[0]"]
    dai_link_platform["dai_link.platforms[0]"]
  end

  subgraph Runtime["ASoC Runtime"]
    pcm_runtime["pcm_runtime"]
    dai_cpu["dai_cpu (struct snd_soc_dai)"]
    dai_codec["dai_codec (struct snd_soc_dai)"]
  end

  %% Bindings t·ª´ Device Tree sang driver
  DT_cpu_i2s --> cpu_dai_driver
  DT_codec --> codec_driver
  DT_simple_audio_card --> machine_driver_simple_card
  DT_fixed_clock --> codec_driver

  %% Machine driver parse DT v√† l·∫≠p card
  machine_driver_simple_card --> snd_soc_card
  machine_driver_simple_card --> snd_soc_dai_link
  snd_soc_dai_link --> dai_link_cpu
  snd_soc_dai_link --> dai_link_codec
  snd_soc_dai_link --> dai_link_platform

  %% Codec v√† CPU ƒëƒÉng k√Ω DAI
  codec_driver --> dai_codec
  cpu_dai_driver --> dai_cpu
  platform_driver --> dai_link_platform

  %% Card n·ªëi CPU DAI v√† Codec DAI
  dai_link_cpu --> dai_cpu
  dai_link_codec --> dai_codec
  snd_soc_card --> pcm_runtime

```
Trong h·ªá th·ªëng ASoC, c√°c th√†nh ph·∫ßn CPU DAI, Codec, Machine driver v√† Platform ƒë∆∞·ª£c k·∫øt n·ªëi th√¥ng qua m√¥ h√¨nh chu·∫©n c·ªßa ALSA. Tr√™n Raspberry Pi 4, ph·∫ßn t·ª≠ **I2S** ƒë∆∞·ª£c k√≠ch ho·∫°t t·ª´ Device Tree node `&i2s`. Khi node n√†y ƒë∆∞·ª£c b·∫≠t, driver **bcm2835-i2s** ƒë∆∞·ª£c n·∫°p, th·ª±c hi·ªán h√†m `bcm2835_i2s_probe()` v√† ƒëƒÉng k√Ω DAI th√¥ng qua `snd_soc_register_component()`. T·ª´ ƒë√≥, ASoC core kh·ªüi t·∫°o m·ªôt th·ª±c th·ªÉ `struct snd_soc_dai` cho CPU DAI, ƒë∆∞·ª£c g·ªçi l√† `dai_cpu`.

·ªû ph√≠a codec, Device Tree c√≥ node `wm8960@1a` v·ªõi `compatible = "wlf,wm8960"`. Khi kernel qu√©t node n√†y, driver **wm8960** ƒë∆∞·ª£c match v√† h√†m `wm8960_i2c_probe()` ƒë∆∞·ª£c g·ªçi. Trong qu√° tr√¨nh probe, driver g·ªçi `devm_snd_soc_register_component()` ƒë·ªÉ ƒëƒÉng k√Ω component v√† DAI c·ªßa codec. ƒê·ªìng th·ªùi, driver s·ª≠ d·ª•ng `devm_clk_get("mclk")` ƒë·ªÉ l·∫•y clock t·ª´ node fixed-clock ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a trong Device Tree. K·∫øt qu·∫£ l√† m·ªôt `struct snd_soc_component` v√† m·ªôt DAI codec (`dai_codec`) ƒë∆∞·ª£c t·∫°o ra v√† qu·∫£n l√Ω b·ªüi ASoC core.

ƒê·ªÉ k·∫øt n·ªëi CPU DAI v√† Codec DAI, h·ªá th·ªëng s·ª≠ d·ª•ng machine driver **simple-audio-card**. Node `sound` trong Device Tree c√≥ `compatible = "simple-audio-card"` ch·ª©a th√¥ng tin ƒë·ªãnh d·∫°ng (format), master/slave, v√† li√™n k·∫øt ƒë·∫øn node CPU v√† Codec. Khi probe, driver simple-audio-card th·ª±c hi·ªán h√†m `asoc_simple_card_probe()`, parse th√¥ng tin t·ª´ Device Tree v√† ƒëi·ªÅn v√†o `struct snd_soc_dai_link`. Trong ƒë√≥, tr∆∞·ªùng `cpus[0].of_node` tr·ªè v·ªÅ node `&i2s`, `codecs[0].of_node` tr·ªè v·ªÅ node `&codec`, v√† `platforms[0].of_node` c≈©ng tham chi·∫øu CPU node ƒë·ªÉ s·ª≠ d·ª•ng PCM platform driver. T·∫•t c·∫£ c√°c `dai_link` n√†y ƒë∆∞·ª£c g·∫Øn v√†o `struct snd_soc_card`, t·∫°o n√™n m·ªôt sound card logic trong kernel.

Khi c√°c DAI ƒë∆∞·ª£c ƒëƒÉng k√Ω ƒë·∫ßy ƒë·ªß, ASoC core th·ª±c hi·ªán qu√° tr√¨nh binding: `dai_link.cpus[0]` ƒë∆∞·ª£c li√™n k·∫øt v·ªõi `dai_cpu` t·ª´ bcm2835-i2s, `dai_link.codecs[0]` ƒë∆∞·ª£c li√™n k·∫øt v·ªõi `dai_codec` t·ª´ wm8960, v√† `dai_link.platforms[0]` ƒë∆∞·ª£c k·∫øt n·ªëi v·ªõi platform driver `bcm2835-pcm`. Sau khi binding ho√†n t·∫•t, ASoC core kh·ªüi t·∫°o m·ªôt `struct snd_soc_pcm_runtime`, gom t·∫•t c·∫£ CPU DAI, Codec DAI v√† platform driver th√†nh m·ªôt pipeline ho√†n ch·ªânh. 

K·∫øt qu·∫£ cu·ªëi c√πng, user space s·∫Ω th·∫•y thi·∫øt b·ªã √¢m thanh m·ªõi trong `/dev/snd/`, v√≠ d·ª• `pcmC1D0p` v√† `pcmC1D0c`. Khi ch·∫°y `aplay -l`, ng∆∞·ªùi d√πng c√≥ th·ªÉ th·∫•y card WM8960 ƒë∆∞·ª£c ƒëƒÉng k√Ω v·ªõi driver bcm2835-i2s v√† platform bcm2835-pcm. Nh∆∞ v·∫≠y, to√†n b·ªô chu·ªói t·ª´ Device Tree ‚Üí Driver ‚Üí ASoC core ‚Üí PCM runtime ƒë∆∞·ª£c kh√©p k√≠n, cho ph√©p truy·ªÅn v√† x·ª≠ l√Ω lu·ªìng √¢m thanh gi·ªØa CPU v√† codec qua bus I¬≤S.

![alt text](result_wm8960.jpg)

## üìå K·∫øt lu·∫≠n
H·ªá th·ªëng ALSA trong kh√¥ng gian kernel cung c·∫•p m·ªôt ki·∫øn tr√∫c √¢m thanh m·∫°nh m·∫Ω v√† m√¥-ƒëun cho Linux, ƒë·∫∑c bi·ªát ph√π h·ª£p v·ªõi c√°c thi·∫øt b·ªã nh√∫ng (embedded) v√† SoC. V·ªõi m√¥ h√¨nh ASoC (ALSA System-on-Chip), driver √¢m thanh ƒë∆∞·ª£c t√°ch th√†nh ba ph·∫ßn r√µ r√†ng: **codec driver** ƒë·ªÉ ƒëi·ªÅu khi·ªÉn chip ADC/DAC, **CPU Dai** ƒë·ªÉ x·ª≠ l√Ω DMA v√† t∆∞∆°ng t√°c ph·∫ßn c·ª©ng, v√† **machine driver** ƒë·ªÉ k·∫øt n·ªëi hai th√†nh ph·∫ßn tr√™n theo ƒë·∫∑c t·∫£ ph·∫ßn c·ª©ng c·ª• th·ªÉ. C·∫•u h√¨nh ph·∫ßn c·ª©ng ƒë∆∞·ª£c ho√†n thi·ªán th√¥ng qua Device Tree, gi√∫p t√°ch bi·ªát logic ph·∫ßn c·ª©ng ra kh·ªèi m√£ ngu·ªìn driver. Nh·ªù ƒë√≥, ALSA trong kernel space kh√¥ng ch·ªâ ƒë·∫£m b·∫£o hi·ªáu nƒÉng v√† t√≠nh ·ªïn ƒë·ªãnh cao m√† c√≤n d·ªÖ d√†ng m·ªü r·ªông v√† t√πy bi·∫øn cho nhi·ªÅu lo·∫°i thi·∫øt b·ªã √¢m thanh kh√°c nhau.